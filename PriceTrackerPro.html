<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tracker Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #00b4d8; --primary-dark: #0096c7; --secondary: #457b9d;
            --danger: #e63946; --success: #2a9d8f; --bg-light: #f8f9fa;
            --surface: #ffffff; --text-dark: #1a1a2e; --text-light: #666666;
            --border: #e0e0e0; --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        html { font-family: 'Segoe UI', sans-serif; font-size: 16px; background: var(--bg-light); color: var(--text-dark); }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 40px; }
        header h1 { font-size: 2.5rem; margin-bottom: 8px; }
        header p { font-size: 1.1rem; opacity: 0.95; }
        .upload-section { background: var(--surface); padding: 40px; margin-bottom: 30px; border: 2px dashed var(--primary); border-radius: 16px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-section:hover { border-color: var(--primary-dark); background: rgba(0, 180, 216, 0.02); }
        .upload-section.drag-over { border-color: var(--primary-dark); background: rgba(0, 180, 216, 0.1); transform: scale(1.02); }
        .upload-icon { font-size: 3rem; margin-bottom: 16px; }
        .upload-section h2 { font-size: 1.5rem; margin-bottom: 12px; }
        .upload-section p { color: var(--text-light); margin-bottom: 24px; }
        input[type="file"] { display: none; }
        .btn { display: inline-block; padding: 12px 32px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0, 180, 216, 0.3); }
        .btn-secondary { background: var(--secondary); color: white; padding: 8px 16px; font-size: 0.9rem; margin-bottom: 16px; }
        .btn-tertiary { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-tertiary:hover { background: rgba(0, 180, 216, 0.1); }
        .message { padding: 16px; margin: 20px 0; border-radius: 8px; display: none; border-left: 4px solid; }
        .message.show { display: block; }
        .message.success { background: rgba(42, 157, 143, 0.15); color: var(--success); border-color: var(--success); }
        .message.error { background: rgba(230, 57, 70, 0.15); color: var(--danger); border-color: var(--danger); }

        /* –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É */
        .requirements { display: none; background: var(--surface); padding: 30px; margin: 20px 0; border-radius: 12px; box-shadow: var(--shadow); border-top: 4px solid var(--primary); }
        .requirements.show { display: block; animation: slideDown 0.4s ease-out; }
        .requirements h3 { margin-bottom: 20px; color: var(--text-dark); font-size: 1.3rem; }
        .requirements-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .requirement-card { background: linear-gradient(135deg, rgba(0, 180, 216, 0.05) 0%, rgba(69, 123, 157, 0.05) 100%); padding: 20px; border-radius: 10px; border-left: 4px solid var(--primary); }
        .requirement-card h4 { color: var(--primary); margin-bottom: 12px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .requirement-card p { color: var(--text-light); font-size: 0.95rem; line-height: 1.6; }
        .column-example { background: var(--bg-light); padding: 12px; border-radius: 6px; margin: 12px 0; font-family: monospace; font-size: 0.9rem; border-left: 3px solid var(--primary); }
        .column-required { color: var(--danger); font-weight: 600; }
        .column-optional { color: var(--text-light); font-style: italic; }

        /* –¢–∞–±–ª–∏—Ü–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ */
        .format-table { width: 100%; margin-top: 20px; border-collapse: collapse; background: var(--bg-light); border-radius: 8px; overflow: hidden; }
        .format-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 14px; text-align: left; font-weight: 600; }
        .format-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); }
        .format-table tbody tr:hover { background: rgba(0, 180, 216, 0.05); }
        .format-table .col-num { text-align: center; width: 60px; font-weight: 600; color: var(--primary); }
        .format-table .col-required { color: var(--danger); font-weight: 600; }
        .format-table .col-optional { color: var(--text-light); }

        .toggle-requirements { display: inline-block; margin-bottom: 20px; }
        .requirements-summary { display: flex; gap: 30px; margin: 20px 0; flex-wrap: wrap; }
        .summary-item { display: flex; align-items: center; gap: 10px; }
        .summary-badge { display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-weight: 700; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .file-info { background: var(--surface); padding: 20px; margin: 20px 0; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--primary); display: none; }
        .file-info.show { display: block; animation: slideDown 0.3s ease-out; }
        .file-info p { margin: 8px 0; font-size: 0.95rem; }
        .file-info strong { color: var(--primary); }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading.show { display: block; }
        .spinner { display: inline-block; width: 50px; height: 50px; border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .results { display: none; }
        .results.show { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 24px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--primary); }
        .stat-card.danger { border-left-color: var(--danger); }
        .stat-card.success { border-left-color: var(--success); }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; color: var(--primary); }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.success .stat-value { color: var(--success); }
        .stat-label { font-size: 0.95rem; color: var(--text-light); }
        .tabs { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-light); transition: all 0.3s; }
        .tab-btn:hover { border-color: var(--primary); color: var(--primary); }
        .tab-btn.active { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-color: transparent; }
        .tab-content { display: none; background: var(--surface); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); }
        .tab-content.active { display: block; }
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; max-width: 400px; padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; }
        .search-box input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        thead { background: linear-gradient(135deg, var(--bg-light) 0%, #f0f0f0 100%); }
        th { padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; transition: all 0.2s; }
        th:hover { background: rgba(0, 180, 216, 0.1); }
        th.active { background: rgba(0, 180, 216, 0.15); color: var(--primary); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: rgba(0, 180, 216, 0.05); }
        .price-up { color: var(--danger); font-weight: 600; }
        .price-down { color: var(--success); font-weight: 600; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-left: 8px; }
        .badge-up { background: rgba(230, 57, 70, 0.15); color: var(--danger); }
        .badge-down { background: rgba(42, 157, 143, 0.15); color: var(--success); }
        .no-data { text-align: center; padding: 60px 20px; color: var(--text-light); }
        .table-wrapper { overflow-x: auto; }
        @media (max-width: 768px) { header h1 { font-size: 1.8rem; } .stats-grid { grid-template-columns: 1fr; } table { font-size: 0.85rem; } th, td { padding: 8px; } .requirements-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Price Tracker Pro</h1>
            <p>–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–≤</p>
        </header>

        <div class="upload-section" id="uploadSection" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <div class="upload-icon">üìÅ</div>
            <h2>–ó–∞–≥—Ä—É–∑–∏ Excel —Ñ–∞–π–ª</h2>
            <p>–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É. –¢—Ä–µ–±—É–µ—Ç—Å—è 2 –ª–∏—Å—Ç–∞</p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
            <div style="margin-top: 20px;">
                <button class="btn btn-tertiary" onclick="toggleRequirements()">‚ÑπÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É</button>
            </div>
        </div>

        <div id="requirements" class="requirements">
            <h3>üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É Excel —Ñ–∞–π–ª–∞</h3>

            <div class="requirements-summary">
                <div class="summary-item">
                    <div class="summary-badge">2</div>
                    <span>–†–æ–≤–Ω–æ 2 –ª–∏—Å—Ç–∞ –≤ —Ñ–∞–π–ª–µ</span>
                </div>
                <div class="summary-item">
                    <div class="summary-badge">üìÖ</div>
                    <span>–õ–∏—Å—Ç—ã –Ω–∞–∑–≤–∞–Ω—ã –¥–∞—Ç–∞–º–∏/–ø–µ—Ä–∏–æ–¥–∞–º–∏</span>
                </div>
                <div class="summary-item">
                    <div class="summary-badge">üìä</div>
                    <span>–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ = –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å</span>
                </div>
            </div>

            <h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--text-dark);">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏:</h4>

            <table class="format-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>–ö–æ–ª–æ–Ω–∫–∞</th>
                        <th>–¢–∏–ø</th>
                        <th>–ü—Ä–∏–º–µ—Ä</th>
                        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="col-num">1</td>
                        <td><span class="col-required">–ê—Ä—Ç–∏–∫—É–ª</span></td>
                        <td>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞</td>
                        <td>SKU-12345</td>
                        <td>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞</td>
                    </tr>
                    <tr>
                        <td class="col-num">2</td>
                        <td><span class="col-optional">–ë—Ä–µ–Ω–¥</span></td>
                        <td>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</td>
                        <td>Samsung</td>
                        <td>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</td>
                    </tr>
                    <tr>
                        <td class="col-num">3</td>
                        <td><span class="col-optional">–ú–æ–¥–µ–ª—å</span></td>
                        <td>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</td>
                        <td>UE65AU7100</td>
                        <td>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</td>
                    </tr>
                    <tr style="background: rgba(0, 180, 216, 0.08);">
                        <td class="col-num">4+</td>
                        <td><span class="col-required">–¶–µ–Ω–∞</span></td>
                        <td>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞</td>
                        <td>45000</td>
                        <td>–ß–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞</td>
                    </tr>
                </tbody>
            </table>

            <div class="requirements-grid">
                <div class="requirement-card">
                    <h4>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ</h4>
                    <div class="column-example">
–ê—Ä—Ç–∏–∫—É–ª | –ë—Ä–µ–Ω–¥ | –ú–æ–¥–µ–ª—å | –¶–µ–Ω–∞
SKU001  | LG    | 43UN | 28000
SKU002  | Samsung| UE55| 35000
                    </div>
                </div>
                <div class="requirement-card">
                    <h4>‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</h4>
                    <div class="column-example">
SKU | –¶–µ–Ω–∞ | –ú–æ–¥–µ–ª—å | –ë—Ä–µ–Ω–¥
(–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)

–¶–µ–Ω–∞001 | 28000
(–Ω–µ—Ç –∞—Ä—Ç–∏–∫—É–ª–∞)
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: rgba(42, 157, 143, 0.1); border-radius: 8px; border-left: 3px solid var(--success);">
                <p><strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º, –ø–æ—ç—Ç–æ–º—É –∏—Ö –ø–æ—Ä—è–¥–æ–∫ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —É–∑–Ω–∞–≤–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è.</p>
            </div>
        </div>

        <div id="message" class="message"></div>

        <div id="fileInfo" class="file-info">
            <p>üìÖ <strong>–°—Ç–∞—Ä—ã–π –ø—Ä–∞–π—Å:</strong> <span id="sheet1-name"></span></p>
            <p>üìÖ <strong>–ù–æ–≤—ã–π –ø—Ä–∞–π—Å:</strong> <span id="sheet2-name"></span></p>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: white;">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...</p>
        </div>

        <div class="results" id="results">
            <div class="stats-grid" id="stats"></div>
            <div class="tabs" id="tabs"></div>

            <div id="tab-changes" class="tab-content">
                <div class="search-box">
                    <input type="text" id="search-changes" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('changes')">
                </div>
                <button class="btn btn-secondary" onclick="exportCSV('changes')">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                <div class="table-wrapper">
                    <table><thead><tr><th onclick="sortTable('changes', 'art')">–ê—Ä—Ç–∏–∫—É–ª</th><th onclick="sortTable('changes', 'brand')">–ë—Ä–µ–Ω–¥</th><th onclick="sortTable('changes', 'model')">–ú–æ–¥–µ–ª—å</th><th onclick="sortTable('changes', 'op')">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</th><th onclick="sortTable('changes', 'np')">–ù–æ–≤–∞—è —Ü–µ–Ω–∞</th><th onclick="sortTable('changes', 'ch')">–°—É–º–º–∞ (‚ÇΩ)</th><th onclick="sortTable('changes', 'pct')">–ü—Ä–æ—Ü–µ–Ω—Ç (%)</th></tr></thead><tbody id="body-changes"></tbody></table>
                </div>
            </div>

            <div id="tab-removed" class="tab-content">
                <div class="search-box">
                    <input type="text" id="search-removed" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('removed')">
                </div>
                <button class="btn btn-secondary" onclick="exportCSV('removed')">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                <div class="table-wrapper">
                    <table><thead><tr><th onclick="sortTable('removed', 'art')">–ê—Ä—Ç–∏–∫—É–ª</th><th onclick="sortTable('removed', 'brand')">–ë—Ä–µ–Ω–¥</th><th onclick="sortTable('removed', 'model')">–ú–æ–¥–µ–ª—å</th><th onclick="sortTable('removed', 'p')">–¶–µ–Ω–∞</th></tr></thead><tbody id="body-removed"></tbody></table>
                </div>
            </div>

            <div id="tab-new" class="tab-content">
                <div class="search-box">
                    <input type="text" id="search-new" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable('new')">
                </div>
                <button class="btn btn-secondary" onclick="exportCSV('new')">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                <div class="table-wrapper">
                    <table><thead><tr><th onclick="sortTable('new', 'art')">–ê—Ä—Ç–∏–∫—É–ª</th><th onclick="sortTable('new', 'brand')">–ë—Ä–µ–Ω–¥</th><th onclick="sortTable('new', 'model')">–ú–æ–¥–µ–ª—å</th><th onclick="sortTable('new', 'p')">–¶–µ–Ω–∞</th></tr></thead><tbody id="body-new"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let data = { changes: [], removed: [], new: [] };
        let originalData = { changes: [], removed: [], new: [] };
        let sortState = { changes: {}, removed: {}, new: {} };
        let sheet1Name = '';
        let sheet2Name = '';

        function toggleRequirements() {
            document.getElementById('requirements').classList.toggle('show');
        }

        function msg(text, type) {
            const el = document.getElementById('message');
            el.textContent = text;
            el.className = 'message show ' + type;
            setTimeout(() => el.className = 'message', 5000);
        }

        function handleDragOver(e) { e.preventDefault(); document.getElementById('uploadSection').classList.add('drag-over'); }
        function handleDragLeave(e) { document.getElementById('uploadSection').classList.remove('drag-over'); }
        function handleDrop(e) { e.preventDefault(); document.getElementById('uploadSection').classList.remove('drag-over'); if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]); }
        function handleFileSelect(e) { if (e.target.files.length) processFile(e.target.files[0]); }

        function processFile(file) {
            if (!file.name.match(/\.xlsx?$/i)) { msg('‚ùå –ó–∞–≥—Ä—É–∑–∏ Excel —Ñ–∞–π–ª', 'error'); return; }
            document.getElementById('loading').classList.add('show');
            document.getElementById('fileInfo').classList.remove('show');

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    if (typeof XLSX === 'undefined') throw new Error('XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å');
                    const wb = XLSX.read(e.target.result, { type: 'array' });
                    if (wb.SheetNames.length < 2) throw new Error('–ù—É–∂–Ω–æ 2 –ª–∏—Å—Ç–∞');

                    sheet1Name = wb.SheetNames[0];
                    sheet2Name = wb.SheetNames[1];

                    const s1 = XLSX.utils.sheet_to_json(wb.Sheets[sheet1Name]);
                    const s2 = XLSX.utils.sheet_to_json(wb.Sheets[sheet2Name]);

                    if (!s1.length || !s2.length) throw new Error('–õ–∏—Å—Ç—ã –ø—É—Å—Ç—ã');

                    analyze(s1, s2);

                    document.getElementById('sheet1-name').textContent = sheet1Name;
                    document.getElementById('sheet2-name').textContent = sheet2Name;
                    document.getElementById('fileInfo').classList.add('show');

                    msg(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ! –õ–∏—Å—Ç 1: ${s1.length}, –õ–∏—Å—Ç 2: ${s2.length}`, 'success');
                    render();
                } catch (err) {
                    msg('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                } finally {
                    document.getElementById('loading').classList.remove('show');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function analyze(old, neu) {
            const keys = Object.keys(old[0] || {});
            const artKey = keys.find(k => k.toLowerCase().includes('–∞—Ä—Ç–∏–∫—É–ª')) || keys[0];
            const priceKey = keys.find(k => k.toLowerCase().includes('—Ü–µ–Ω–∞')) || keys[keys.length - 1];
            const brandKey = keys.find(k => k.toLowerCase().includes('–±—Ä–µ–Ω–¥')) || '';
            const modelKey = keys.find(k => k.toLowerCase().includes('–º–æ–¥–µ–ª—å')) || '';

            const oldMap = {}, neuMap = {};
            old.forEach(r => { if (r[artKey]) oldMap[r[artKey]] = r; });
            neu.forEach(r => { if (r[artKey]) neuMap[r[artKey]] = r; });

            data = { changes: [], removed: [], new: [] };

            Object.keys(oldMap).forEach(k => {
                if (neuMap[k]) {
                    const op = parseFloat(oldMap[k][priceKey]) || 0;
                    const np = parseFloat(neuMap[k][priceKey]) || 0;
                    if (op !== np) {
                        data.changes.push({
                            art: k,
                            brand: brandKey ? oldMap[k][brandKey] : '',
                            model: modelKey ? oldMap[k][modelKey] : '',
                            op: op,
                            np: np,
                            ch: np - op,
                            pct: parseFloat(((np - op) / op * 100).toFixed(1))
                        });
                    }
                }
            });

            Object.keys(oldMap).forEach(k => {
                if (!neuMap[k]) {
                    data.removed.push({
                        art: k,
                        brand: brandKey ? oldMap[k][brandKey] : '',
                        model: modelKey ? oldMap[k][modelKey] : '',
                        p: parseFloat(oldMap[k][priceKey]) || 0
                    });
                }
            });

            Object.keys(neuMap).forEach(k => {
                if (!oldMap[k]) {
                    data.new.push({
                        art: k,
                        brand: brandKey ? neuMap[k][brandKey] : '',
                        model: modelKey ? neuMap[k][modelKey] : '',
                        p: parseFloat(neuMap[k][priceKey]) || 0
                    });
                }
            });

            originalData = JSON.parse(JSON.stringify(data));
        }

        function render() {
            const up = data.changes.filter(x => x.ch > 0);
            const down = data.changes.filter(x => x.ch < 0);
            const avgUp = up.length ? (up.reduce((s, x) => s + x.pct, 0) / up.length).toFixed(1) : 0;
            const avgDown = down.length ? (down.reduce((s, x) => s + x.pct, 0) / down.length).toFixed(1) : 0;

            document.getElementById('stats').innerHTML = `
                <div class="stat-card"><div class="stat-value">${data.changes.length}</div><div class="stat-label">–ò–∑–º–µ–Ω–µ–Ω—ã</div></div>
                <div class="stat-card danger"><div class="stat-value">${up.length}</div><div class="stat-label">–ü–æ–¥–æ—Ä–æ–∂–∞–ª–∏ (+${avgUp}%)</div></div>
                <div class="stat-card success"><div class="stat-value">${down.length}</div><div class="stat-label">–ü–æ–¥–µ—à–µ–≤–µ–ª–∏ (${avgDown}%)</div></div>
                <div class="stat-card danger"><div class="stat-value">${data.removed.length}</div><div class="stat-label">–£–¥–∞–ª–µ–Ω—ã</div></div>
                <div class="stat-card success"><div class="stat-value">${data.new.length}</div><div class="stat-label">–î–æ–±–∞–≤–ª–µ–Ω—ã</div></div>
            `;

            document.getElementById('tabs').innerHTML = `
                <button class="tab-btn active" onclick="switchTab('changes')">üí∞ –ò–∑–º–µ–Ω–µ–Ω–∏—è (${data.changes.length})</button>
                <button class="tab-btn" onclick="switchTab('removed')">‚ùå –£–¥–∞–ª–µ–Ω—ã (${data.removed.length})</button>
                <button class="tab-btn" onclick="switchTab('new')">‚ú® –ù–æ–≤—ã–µ (${data.new.length})</button>
            `;

            renderTable('changes');
            renderTable('removed');
            renderTable('new');
            document.getElementById('results').classList.add('show');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            event.target.classList.add('active');
        }

        function renderTable(type) {
            const tbody = document.getElementById('body-' + type);
            const items = data[type];

            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }

            if (type === 'changes') {
                tbody.innerHTML = items.map(r => `<tr><td>${r.art}</td><td>${r.brand}</td><td>${r.model}</td><td>${r.op.toLocaleString('ru-RU')}</td><td>${r.np.toLocaleString('ru-RU')}</td><td><span class="${r.ch > 0 ? 'price-up' : 'price-down'}">${r.ch > 0 ? '+' : ''}${r.ch.toLocaleString('ru-RU')}</span></td><td><span class="badge ${r.ch > 0 ? 'badge-up' : 'badge-down'}">${r.pct > 0 ? '+' : ''}${r.pct}%</span></td></tr>`).join('');
            } else if (type === 'removed') {
                tbody.innerHTML = items.map(r => `<tr><td>${r.art}</td><td>${r.brand}</td><td>${r.model}</td><td>${r.p.toLocaleString('ru-RU')}</td></tr>`).join('');
            } else {
                tbody.innerHTML = items.map(r => `<tr><td>${r.art}</td><td>${r.brand}</td><td>${r.model}</td><td>${r.p.toLocaleString('ru-RU')}</td></tr>`).join('');
            }
        }

        function sortTable(type, field) {
            const sort = sortState[type] || {};
            if (sort.field === field) {
                sort.asc = !sort.asc;
            } else {
                sort.field = field;
                sort.asc = true;
            }
            sortState[type] = sort;

            data[type].sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                if (typeof aVal === 'number') { aVal = aVal || 0; bVal = bVal || 0; } else if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase(); }
                let result = 0;
                if (aVal > bVal) result = 1;
                if (aVal < bVal) result = -1;
                return sort.asc ? result : -result;
            });

            renderTable(type);

            document.querySelectorAll('#tab-' + type + ' th').forEach((th, i) => {
                th.classList.remove('active');
                const thField = ['art', 'brand', 'model', type === 'changes' ? 'op' : 'p', type === 'changes' ? 'np' : null, type === 'changes' ? 'ch' : null, type === 'changes' ? 'pct' : null].filter(f => f)[i];
                if (thField === field) th.classList.add('active');
            });
        }

        function filterTable(type) {
            const term = document.getElementById('search-' + type).value.toLowerCase();
            data[type] = term ? originalData[type].filter(r => r.art.toLowerCase().includes(term) || r.brand.toLowerCase().includes(term) || r.model.toLowerCase().includes(term)) : JSON.parse(JSON.stringify(originalData[type]));
            renderTable(type);
        }

        function exportCSV(type) {
            const items = data[type];
            if (!items.length) { alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
            const headers = type === 'changes' ? ['–ê—Ä—Ç–∏–∫—É–ª', '–ë—Ä–µ–Ω–¥', '–ú–æ–¥–µ–ª—å', '–°—Ç–∞—Ä–∞—è', '–ù–æ–≤–∞—è', '–°—É–º–º–∞', '%'] : ['–ê—Ä—Ç–∏–∫—É–ª', '–ë—Ä–µ–Ω–¥', '–ú–æ–¥–µ–ª—å', '–¶–µ–Ω–∞'];
            let csv = headers.join(',') + '\n';
            csv += items.map(r => type === 'changes' ? [r.art, r.brand, r.model, r.op, r.np, r.ch, r.pct].join(',') : [r.art, r.brand, r.model, r.p].join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = type + '-' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }
    </script>
</body>
</html>